% \setcounter{section}{1}
\section{Biểu đồ tuần tự}
\label{sec:sequence}

\subsection{Chatbot}
\label{sec:sequence_chatbot}
Quá trình hoạt động của chatbot được mô tả như sau. Khi người dùng gửi câu hỏi thì 
sẽ có 2 loại dữ liệu nhận vào là văn bản và âm thanh.\\
Đối với dữ liệu là âm thanh, hệ thống sẽ chuyển đổi âm thanh thành văn bản và trả ngược về cho ứng dụng.
Sau đó, ứng dụng sẽ trả về cho ứng dụng là văn bản đã được chuyển đổi từ giọng nói. Sau đó,
ứng dụng sẽ gọi API của chatbot với đầu vào là dạng văn bản.
Hình~\ref{fig:voice_to_text} mô tả quá trình này
\begin{figure}
	\centering
	\includegraphics[width=1\textwidth]{figures/voice_to_text.png}
	\caption{Biểu đồ tuần tự cho quá trình chuyển đổi giọng nói thành văn bản}
	\label{fig:voice_to_text}
\end{figure}

Còn đối với dữ liệu là văn bản, người dùng sẽ gọi trực tiếp API của chatbot với đầu vào là văn bản.
Và sau khi nhận được yêu cầu từ ứng dụng, chatbot sẽ lấy dữ liệu cũ (nếu có) theo luồng được định danh đối với mỗi chuỗi đầu vào.
Nếu chưa có dữ liệu cũ, chatbot sẽ tạo một luồng mới để lưu trữ dữ liệu dùng cho sau này.
Sau đó, chatbot sẽ tổng hợp cả dữ liệu cũ theo luồng và dữ liệu mới từ người dùng để tạo thành một đầu vào hoàn chỉnh.
Tiếp theo, chatbot sẽ đưa chuỗi đã được tổng hợp nào tạo thành một yêu cầu hoàn chỉnh và gửi đến LLM để xử lý.
Lúc này LLM sẽ phân tích và xử lý yêu cầu. Nếu cần phải dùng đến các tool hỗ trợ, LLM sẽ có thể gọi các tool như:
\begin{itemize}
	\item Duckduckgo: để tìm kiếm các trang web liên quan đến dữ liệu mà LLM yêu cầu.
	\item ScrapeWebsite: để trích xuất dữ liệu từ các trang web mà LLM muốn lấy thông tin.
\end{itemize}
Sau khi có được đầy đủ các thông tin cần thiết để LLM sẽ tổng hợp và tạo ra câu trả lời cuối cùng.
Cuối cùng, chatbot sẽ lưu lại dữ liệu mới vào luồng tương ứng và có thể xử lý dữ liệu về dạng văn bản hoàn chỉnh,
rõ ràng rồi trả về cho ứng dụng dữ liệu cuối cùng.
Hình~\ref{fig:sequence-chatbot} mô tả quá trình này.

\begin{figure}
	\centering
	\includegraphics[width=1\textwidth]{figures/sequence-chatbot.png}
	\caption{Biểu đồ tuần tự cho chatbot}
	\label{fig:sequence-chatbot}
\end{figure}

\subsection{Đăng ký}
\begin{itemize}
	\item Người dùng nhấn "Sign up for free", giao diện hiển thị form đăng ký.
	\item Gửi thông tin đăng ký qua API Gateway tới Controller, kiểm tra định dạng và tính hợp lệ của dữ liệu.
	\item Nếu thông tin hợp lệ, gửi thông tin cho Service kiểm tra email đã tồn tại chưa, nếu không hiển thị thông báo lỗi.
	\item Nếu email chưa tồn tại, gửi thông tin qua Repo, lưu vào CSDl, nếu không hiển thị thông báo lỗi.
	\item Chuyển đến giao diện đăng nhập.
\end{itemize}
\newpage
\begin{figure}[H]
	\centering
	\includegraphics[width=1\textwidth]{figures/sequence-register.png}
	\caption{Biểu đồ tuần tự cho chức năng đăng ký}	
\end{figure}

\subsection{Đăng nhập}
\begin{itemize}
	\item Người dùng nhấn "Login" và nhập email và mật khẩu hoặc nhấn "Login with Google".
	\item Gửi thông tin đăng nhập qua API Gateway tới Controller, kiểm tra định dạng.
	\item Nếu thông tin hợp lệ, gửi cho Service kiểm tra email đã tồn tại trong CSDl chưa, nếu không thông báo lỗi.
	\item Nếu email tồn tại, kiểm tra thông tin mật khẩu.
	\item Nếu mật khẩu đúng, thông báo thành công, giao diện chuyển sang home, nếu không thông báo lỗi.
\end{itemize}
\newpage
\begin{figure}[H]
	\centering
	\includegraphics[width=1\textwidth]{figures/sequence-login.png}
	\caption{Biểu đồ tuần tự cho chức năng đăng nhập}
	\end{figure}

\subsection{Phát nhạc}
\begin{itemize}
	\item Người dùng nhấn vào hình bản nhạc, client gửi qua API Gateway tới cho Service.
	\item Service tìm Storage Key của bản nhạc và gửi lại cho Client qua API Gateway.
	\item Client gửi Storage Key cho Service, Service trả về link bài nhạc.
	\item Client load giao diện phát nhạc và hiển thị cho người dùng. 
	\item Người dùng thoát giao diện phát nhạc thì hiển thị giao diện home, khi vào lại hiển thị thanh điều nhạc ở bên dưới.
\end{itemize}
\newpage
\begin{figure}[H]
	\centering
	\includegraphics[width=1\textwidth]{figures/sequence-playingsong.png}
	\caption{Biểu đồ tuần tự cho chức năng phát nhạc}
	\end{figure}

\subsection{Xem bài hát gần đây}
\begin{itemize}
	\item Người dùng vào giao diện home, Client gửi yêu cầu lấy lịch sử nghe nhạc qua API Gateway tới Service.
	\item Service truy vấn và nhận lịch sử nghe nhạc từ CSDL.
	\item Nếu người dùng đã từng nghe nhạc, Service trả về danh sách lịch sử nghe nhạc qua API Gateway cho Client. 
	\item Client load các bài hát trong lịch sử nghe nhạc lên giao diện home.
	\item Nếu người dùng chưa nghe nhạc, Service trả về danh sách rỗng, Client hiển thị thông báo "Chưa có lịch sử nghe nhạc"
\end{itemize}
\newpage
\begin{figure}[H]
	\centering
	\includegraphics[width=1\textwidth]{figures/sequence-historysongs.png}
	\caption{Biểu đồ tuần tự cho chức năng xem bài hát gần đây}
	\end{figure}

\subsection{Lưu bài hát yêu thích}
\begin{itemize}
	\item Người dùng nhấn nút "Favorite", Client gửi yêu cầu qua API Gateway cho Service.
	\item Service gửi truy vấn tới CSDL để lưu thông tin.
	\item Nếu lưu vào CSDL thành công, Service trả về thành công, Client cập nhật UI.
	\item Nếu lưu vào CSLD không thành công, Service trả về lỗi, CLient hiển thị thông báo lỗi.
\end{itemize}
\newpage
\begin{figure}[H]
	\centering
	\includegraphics[width=1\textwidth]{figures/sequence-addfavorite.png}
	\caption{Biểu đồ tuần tự cho chức năng lưu bài hát yêu thích}
	\end{figure}

\subsection{Sửa thông tin cá nhân}
\begin{itemize}
	\item Người dùng nhập thông tin vào form thông tin cá nhân/mật khẩu/avatar, Client gửi thông tin qua API Gateway tới Service.
	\item Service gửi truy vấn tới CSDL để lưu thông tin.
	\item Nếu lưu vào CSDL thành công, Service trả về thành công, Client cập nhật UI.
	\item Nếu lưu vào CSLD không thành công, Service trả về lỗi, CLient hiển thị thông báo lỗi.
\end{itemize}
\newpage
\begin{figure}[H]
	\centering
	\includegraphics[width=1\textwidth]{figures/sequence-updateprofile.png}
	\caption{Biểu đồ tuần tự cho chức năng sửa thông tin cá nhân}
	\end{figure}
